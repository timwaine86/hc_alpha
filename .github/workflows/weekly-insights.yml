name: weekly-insights

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'  # Mondays 06:00 UTC

permissions:
  contents: read

jobs:
  weekly_job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas python-dateutil python-dotenv requests openai==1.51.2 tenacity

            - name: Fetch MAS+ data from Apify
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p pipeline
          OUT="pipeline/latest_posts.csv"

          call_actor () {
            local payload="$1"
            local fmt="$2"   # csv or json
            local out="$3"

            curl -sS \
              -H "Authorization: Bearer ${APIFY_TOKEN}" \
              -H "Content-Type: application/json" \
              -X POST \
              "https://api.apify.com/v2/acts/apify~instagram-post-scraper/run-sync-get-dataset-items?format=${fmt}&clean=true&token=${APIFY_TOKEN}" \
              -d "${payload}" \
              -o "${out}" \
              -w "%{http_code}"
          }

          # 1) Schema variant A: username as ARRAY
          PAYLOAD_A='{
            "username": ["masbymessi"],
            "maxItems": 30,
            "proxy": { "useApifyProxy": true }
          }'

          # 2) Schema variant B: usernames (plural)
          PAYLOAD_B='{
            "usernames": ["masbymessi"],
            "maxItems": 30,
            "proxy": { "useApifyProxy": true }
          }'

          # Try A
          CODE=$(call_actor "${PAYLOAD_A}" "csv" "${OUT}" || true)
          if [ "${CODE:-}" != "200" ] || [ ! -s "${OUT}" ]; then
            echo "Attempt A failed (HTTP ${CODE:-none}). Retrying with alternate schemaâ€¦"
            # Print error body for A
            call_actor "${PAYLOAD_A}" "json" "pipeline/apify_error_A.json" >/dev/null || true
            sed -n '1,200p' pipeline/apify_error_A.json || true

            # Try B
            CODE=$(call_actor "${PAYLOAD_B}" "csv" "${OUT}" || true)
            if [ "${CODE:-}" != "200" ] || [ ! -s "${OUT}" ]; then
              echo "Attempt B failed (HTTP ${CODE:-none}). Full error body:"
              call_actor "${PAYLOAD_B}" "json" "pipeline/apify_error_B.json" >/dev/null || true
              sed -n '1,200p' pipeline/apify_error_B.json || true
              exit 1
            fi
          fi

          echo "CSV preview:"
          head -5 "${OUT}" || true

      - name: Run baseline to Notion
        env:
          NOTION_TOKEN:       ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_MASPLUS:  ${{ secrets.NOTION_DB_MASPLUS }}
          OPENAI_API_KEY:     ${{ secrets.OPENAI_API_KEY }}
          BASELINE_ER_MEDIAN: '0.95'
          BASELINE_IVR_MEDIAN: '3.09'
          HC_INPUT_CSV:       pipeline/latest_posts.csv
          HC_FOLLOWERS:       '485000'
        run: python pipeline/baseline_check.py
